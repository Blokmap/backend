name: Lint and test code

on:
    push:
        branches-ignore: ["main", "staging"]
        tags-ignore: ["**"]

    workflow_call:

jobs:
    setup:
        runs-on: self-hosted

        steps:
            - name: vague chown hack
              run: sudo chown -R $USER:$USER $GITHUB_WORKSPACE

            - name: Checkout code
              uses: actions/checkout@v4

            - name: Build images
              run: |
                  docker compose \
                  -f .github/compose.yaml \
                  --project-directory . \
                  build

    lint:
        runs-on: self-hosted
        needs: [setup]

        steps:
            - name: Lint code
              run: |
                  docker compose \
                  -f .github/compose.yaml \
                  --project-directory . \
                  run lint

    test:
        runs-on: self-hosted
        needs: [setup]

        steps:
            - name: Run tests
              run: |
                  docker compose \
                  -f .github/compose.yaml \
                  --project-directory . \
                  run test
